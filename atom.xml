<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Double-c</title>
  
  <subtitle>而废不能半途</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="https://double-c.github.io/"/>
  <updated>2018-08-23T09:57:11.306Z</updated>
  <id>https://double-c.github.io/</id>
  
  <author>
    <name>[object Object]</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>初次接触 Yii</title>
    <link href="https://double-c.github.io/2018/08/22/yii2-learn-note/"/>
    <id>https://double-c.github.io/2018/08/22/yii2-learn-note/</id>
    <published>2018-08-22T01:13:38.000Z</published>
    <updated>2018-08-23T09:57:11.306Z</updated>
    
    <content type="html"><![CDATA[<h2 id="Yii2-0"><a href="#Yii2-0" class="headerlink" title="Yii2.0"></a>Yii2.0</h2><blockquote><p>记录下首次接触这个框架学习的点点滴滴</p></blockquote><h4 id="关于-env"><a href="#关于-env" class="headerlink" title="关于 .env"></a>关于 <code>.env</code></h4><p>Yii 默认没支持使用该文件配置项目一些敏感数据，不利于切换环境。 例：数据库连接信息; </p><p>参考 <code>Tinkphp5</code> 源码，自定义函数 <code>env()</code> 让框架支持读取 <code>.env</code> 文件配置</p><p><strong>env.php</strong></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line">defined(<span class="string">'ENV_PREFIX'</span>) <span class="keyword">or</span> define(<span class="string">'ENV_PREFIX'</span>, <span class="string">'PHP_'</span>); <span class="comment">// 环境变量的配置前缀</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 加载环境变量配置文件，根据各个项目入口文件的不同，这里需要自己定义</span></span><br><span class="line">$envFilePath = <span class="keyword">__DIR__</span> . <span class="string">'/../.env'</span>;</span><br><span class="line"><span class="comment">// 当项目中存在 .env 文件时加载</span></span><br><span class="line"><span class="keyword">if</span> (is_file($envFilePath)) &#123;</span><br><span class="line">    $env = parse_ini_file(<span class="keyword">__DIR__</span> . <span class="string">'/../.env'</span>, <span class="keyword">true</span>);</span><br><span class="line">    <span class="comment">// 全部转换为大写且以_分割做的命名</span></span><br><span class="line">    <span class="keyword">foreach</span> ($env <span class="keyword">as</span> $key =&gt; $val) &#123;</span><br><span class="line">        $name = ENV_PREFIX . strtoupper($key);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (is_array($val)) &#123;</span><br><span class="line">            <span class="keyword">foreach</span> ($val <span class="keyword">as</span> $k =&gt; $v) &#123;</span><br><span class="line">                $item = $name . <span class="string">'_'</span> . strtoupper($k);</span><br><span class="line">                putenv(<span class="string">"$item=$v"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            putenv(<span class="string">"$name=$val"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!function_exists(<span class="string">'env'</span>)) &#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">env</span><span class="params">($name, $default = null)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">// 支持以 . 符号分隔数组</span></span><br><span class="line">        $result = getenv(ENV_PREFIX . strtoupper(str_replace(<span class="string">'.'</span>, <span class="string">'_'</span>, $name)));</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">false</span> !== $result) &#123;</span><br><span class="line">            <span class="comment">// 如果是布尔值相关的字符串转为布尔值</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="string">'false'</span> === $result) &#123;</span><br><span class="line">                $result = <span class="keyword">false</span>;</span><br><span class="line">            &#125; <span class="keyword">elseif</span> (<span class="string">'true'</span> === $result) &#123;</span><br><span class="line">                $result = <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> $result;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> $default;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="控制器"><a href="#控制器" class="headerlink" title="控制器"></a>控制器</h4><p>控制器中允许路由访问的方法都需要加上 <code>action</code> + 方法名才可以访问。例： <code>actionIndex()</code>。</p><h5 id="actions"><a href="#actions" class="headerlink" title="actions()"></a>actions()</h5><p>比如访问 <code>http://host/site/test</code> 的时候，会先在控制器的 <code>action()</code> 方法中找到对应请求的 <code>test</code> 方法</p><p>如果没有那么就会在控制器中找 <code>actionTest()</code> 方法</p><p>把公共的方法放在 <code>actions()</code> 中，这样要对调用一些公共的静态页面时就可以不用写控制器方法。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">actions</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> [</span><br><span class="line">        <span class="string">'error'</span> =&gt; [</span><br><span class="line">            <span class="string">'class'</span> =&gt; <span class="string">'yii\web\ErrorAction'</span>,</span><br><span class="line">        ],</span><br><span class="line">        <span class="string">'captcha'</span> =&gt; [</span><br><span class="line">            <span class="string">'class'</span> =&gt; <span class="string">'yii\captcha\CaptchaAction'</span>,</span><br><span class="line">            <span class="string">'fixedVerifyCode'</span> =&gt; YII_ENV_TEST ? <span class="string">'testme'</span> : <span class="keyword">null</span>,<span class="comment">// 该值的是传入类的变量名</span></span><br><span class="line">        ],</span><br><span class="line">       <span class="comment">//返回验证</span></span><br><span class="line">        <span class="string">'tests'</span>=&gt;[</span><br><span class="line">             <span class="string">'class'</span>=&gt;<span class="string">'backend\models\TestAction'</span>,</span><br><span class="line">         ]</span><br><span class="line">    ];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="behaviors"><a href="#behaviors" class="headerlink" title="behaviors()"></a>behaviors()</h5><p>在控制器方法执行之前，使用指定的 <code>过滤器</code> 处理数据。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">behaviors</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> [</span><br><span class="line">        <span class="string">'access'</span> =&gt; [</span><br><span class="line">            <span class="string">'class'</span> =&gt; AccessControl::className(), <span class="comment">// 使用核心过滤器Access 对执行动作进行验证</span></span><br><span class="line">            <span class="string">'only'</span> =&gt; [<span class="string">'logout'</span>], <span class="comment">// 对logout动作进行验证</span></span><br><span class="line">            <span class="string">'rules'</span> =&gt; [ <span class="comment">// 规则</span></span><br><span class="line">                [</span><br><span class="line">                    <span class="string">'actions'</span> =&gt; [<span class="string">'logout'</span>],</span><br><span class="line">                    <span class="string">'allow'</span> =&gt; <span class="keyword">true</span>, <span class="comment">// 只允许认证用户进行访问</span></span><br><span class="line">                    <span class="string">'roles'</span> =&gt; [<span class="string">'@'</span>],</span><br><span class="line">                ],</span><br><span class="line">            ],</span><br><span class="line">        ],</span><br><span class="line">        <span class="string">'verbs'</span> =&gt; [ <span class="comment">// 设置curd动作 所运行的请求方式</span></span><br><span class="line">            <span class="string">'class'</span> =&gt; VerbFilter::className(),</span><br><span class="line">            <span class="string">'actions'</span> =&gt; [</span><br><span class="line">                <span class="string">'logout'</span> =&gt; [<span class="string">'post'</span>], <span class="comment">// post 方法</span></span><br><span class="line">            ],</span><br><span class="line">        ],</span><br><span class="line">        ];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="路由"><a href="#路由" class="headerlink" title="路由"></a>路由</h4><h5 id="定义路由"><a href="#定义路由" class="headerlink" title="定义路由"></a>定义路由</h5><p>对应模块的 <code>config</code> 目录下的 <code>main.php</code></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">......</span><br><span class="line">    </span><br><span class="line"><span class="string">'urlManager'</span> =&gt; [</span><br><span class="line">            <span class="string">'enablePrettyUrl'</span> =&gt; <span class="keyword">true</span>,</span><br><span class="line">            <span class="string">'showScriptName'</span> =&gt; <span class="keyword">false</span>,</span><br><span class="line">            <span class="string">'rules'</span> =&gt; [</span><br><span class="line">                <span class="string">'login'</span> =&gt; <span class="string">'site/show-login-form'</span>,<span class="comment">// http://host/login</span></span><br><span class="line">                <span class="string">'news/detail/&lt;id:\d+&gt;'</span> =&gt; <span class="string">'news/detail'</span>,<span class="comment">// http://host/news/detail/1</span></span><br><span class="line">            ]</span><br><span class="line">        ],</span><br></pre></td></tr></table></figure><h5 id="生成路由"><a href="#生成路由" class="headerlink" title="生成路由"></a>生成路由</h5><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 传入路由和参数</span></span><br><span class="line">\yii\helpers\Url::toRoute([<span class="string">"news/detail"</span>, <span class="string">'id'</span> =&gt; $v[<span class="string">'id'</span>]])</span><br></pre></td></tr></table></figure><h4 id="模型"><a href="#模型" class="headerlink" title="模型"></a>模型</h4><h5 id="查询器"><a href="#查询器" class="headerlink" title="查询器"></a>查询器</h5><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 模型静态方法find()返回对应模型的查询器</span></span><br><span class="line">$query = Model::find();</span><br><span class="line"><span class="comment">// where()</span></span><br><span class="line">$query-&gt;where([<span class="string">'id'</span> =&gt; <span class="number">1</span>]);<span class="comment">// 查询id=1</span></span><br><span class="line">$query-&gt;where([<span class="string">'in'</span>, <span class="string">'id'</span>, [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]); <span class="comment">// 查新 id IN (1,2,3)</span></span><br><span class="line">               </span><br><span class="line">$query-&gt;asArray() <span class="comment">// 查询结果以数组返回</span></span><br><span class="line"></span><br><span class="line">$query-&gt;orderBy(<span class="string">'sort desc, push_time desc'</span>);<span class="comment">// 排序</span></span><br><span class="line">               </span><br><span class="line">$query-&gt;all();    <span class="comment">// 返回所有结果</span></span><br></pre></td></tr></table></figure><h4 id="视图"><a href="#视图" class="headerlink" title="视图"></a>视图</h4><h5 id="小部件"><a href="#小部件" class="headerlink" title="小部件"></a>小部件</h5><p>可以重复利用的视图都可以将其用小部件来展示</p><p> 小部件类：<code>model/widget/DemoWidget</code></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">app</span>\<span class="title">widgets</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">app</span>\<span class="title">services</span>\<span class="title">DemoService</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">yii</span>\<span class="title">base</span>\<span class="title">Widget</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DemoWidget</span> <span class="keyword">extends</span> <span class="title">Widget</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $data;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">init</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $service = <span class="keyword">new</span> DemoService();</span><br><span class="line">        <span class="comment">// 获取数据并注入到data属性</span></span><br><span class="line">        <span class="keyword">$this</span>-&gt;data = $service-&gt;getData(<span class="number">10</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">run</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">// 去渲染该路径的视图文件 model/widget/views/demo.php</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;render(<span class="string">'demo'</span>, [</span><br><span class="line">            <span class="string">'data'</span> =&gt; <span class="keyword">$this</span>-&gt;data</span><br><span class="line">        ]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>小部件视图文件： <code>model/widget/views/demo.php</code></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">&lt;div class="xw_wp sw"&gt;</span><br><span class="line">    &lt;div class="con_r"&gt;</span><br><span class="line">        &lt;span class="ln"&gt;&lt;/span&gt;</span><br><span class="line">        &lt;span class="ti"&gt;新闻排行&lt;/span&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">    &lt;ul class="xw"&gt;</span><br><span class="line">        <span class="meta">&lt;?php</span></span><br><span class="line">        $newsNum = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">if</span> (is_array($data)) &#123; <span class="keyword">foreach</span> ($data <span class="keyword">as</span> $v) &#123;</span><br><span class="line">        <span class="meta">?&gt;</span></span><br><span class="line">        &lt;li&gt;</span><br><span class="line">            &lt;a href=<span class="string">"&lt;?= \yii\helpers\Url::toRoute(["</span>news/detail<span class="string">", 'id' =&gt; $v['id']])?&gt;"</span>&gt;</span><br><span class="line">                &lt;span class="ic dls"&gt;&lt;?=$newsNum ?&gt;&lt;/span&gt;</span><br><span class="line">                &lt;span class="ti dls"&gt;&lt;?=\yii\helpers\Html::encode($v['title']) ?&gt;&lt;/span&gt;</span><br><span class="line">            &lt;/a&gt;</span><br><span class="line">        &lt;/li&gt;</span><br><span class="line">        <span class="meta">&lt;?php</span></span><br><span class="line">        $newsNum++;</span><br><span class="line">        &#125;&#125;</span><br><span class="line">        <span class="meta">?&gt;</span></span><br><span class="line">    &lt;/ul&gt;</span><br><span class="line">&lt;/div&gt;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;Yii2-0&quot;&gt;&lt;a href=&quot;#Yii2-0&quot; class=&quot;headerlink&quot; title=&quot;Yii2.0&quot;&gt;&lt;/a&gt;Yii2.0&lt;/h2&gt;&lt;blockquote&gt;
&lt;p&gt;记录下首次接触这个框架学习的点点滴滴&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h4 
      
    
    </summary>
    
      <category term="后端开发" scheme="https://double-c.github.io/categories/%E5%90%8E%E7%AB%AF%E5%BC%80%E5%8F%91/"/>
    
    
      <category term="yii2.0" scheme="https://double-c.github.io/tags/yii2-0/"/>
    
      <category term="php" scheme="https://double-c.github.io/tags/php/"/>
    
  </entry>
  
</feed>
